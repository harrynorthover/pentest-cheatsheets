""" 
generate_index.py </path/to/directory> [--header <header text>]
"""
from __future__ import print_function
from mako.template import Template
import argparse
import os
import os.path
import time

MARKDOWN_TEMPLATE = r"""<h2>Contents</h2>
[Parent Directory](../)

<h3>Directories</h3>
% for name in dirnames:
[${name}](${name})<br />
% endfor

<h3>Sheets</h3>
% for name in filenames:
[${name}](${name})<br />
% endfor
"""

EXCLUDED = ['index.html', 'node_modules', '.husky', '.git', 'generate_index.py',
            'package.json', 'package-lock.json', 'README.md', '_config.yml', '.DS_Store']


def fun(dir, rootdir):
    print('Processing: '+dir)
    filenames = [fname for fname in sorted(os.listdir(dir))
                 if fname not in EXCLUDED and os.path.isfile(dir+fname)]
    dirnames = [fname for fname in sorted(os.listdir(dir))
                if fname not in EXCLUDED]
    dirnames = [fname for fname in dirnames if fname not in filenames]
#    header = os.path.basename(dir)
    f = open(dir+'/README.md', 'w')
    print(Template(MARKDOWN_TEMPLATE).render(dirnames=dirnames, filenames=filenames,
          header=dir, ROOTDIR=rootdir, time=time.ctime(os.path.getctime(dir))), file=f)
    f.close()
    for subdir in dirnames:
        try:
            fun(dir+subdir+"/", rootdir+'../')
        except:
            pass


def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("directory")
    parser.add_argument("--header")
    args = parser.parse_args()
    fun(args.directory+'/', '../')


if __name__ == '__main__':
    main()
