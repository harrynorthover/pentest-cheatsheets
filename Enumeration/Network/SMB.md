# SMB Enumeration
Below is a collection of different commands to gain information on SMB shares, users and much else.

##### Workflows 
*Basic w/ credentials.*
1) Obtain credentials from either AS-REP Roasting or Kerberoasting
2) Check those credentials using CME
3) Crawl available shares using CME -M spider_plus (remember the results go into the /tmp directory)
4) Either `mount` the directory or use `smbget` to download its contents locally

*Basic w/o credentials.*
1) smbmap shares anonymously
2) List shares using smbclient
3) enum4linux
4) crackmapexec spider_plus & --shares

##### Tooling
##### [nmap](https://nmap.org/)
Nmap scan for SMB versions

```
$ nmap -p139,445 --script smb-protocols IP_ADDRESS 
```

Nmap scan with default scripts.

```
$ nmap -sC -p 139,445 -sV IP_ADDRESS
```

Nmap SMB Vulnerability Scan

```
nmap â€” script "smb-vuln" -p 139,445 -oN smb-vuln-scan IP_ADDRESS
```

##### [smbmap](https://github.com/ShawnDEvans/smbmap)
List SMB shares using smbmap

```
$ smbmap -H IP_ADDRESS -R (recursive)
```

Alternative listing command

```
smbmap -H IP_ADDRESS -u null
```

Download file using smbmap

```
smbmap -u svc_tgs -p GPPstillStandingStrong2k18 -d active.htb -H 10.10.10.100 --download "Users/SVC_TGS/Desktop/user.txt"
```

##### [smbclient](https://www.samba.org/samba/docs/current/man-html/smbclient.1.html)
List shares using smbclient

```
$ smbclient -L IP_ADDRESS -N (no password)
```

Upload a file using SMB

```
$ smbclient //IP_ADDRESS/share -c 'cd c:/remote/path ; put LOCAL_FILE REMOTE_FILE'
```

Upload a file with credentials inlined

```
smbclient -c 'put myservice.exe' -U t1_leonard.summers -W ZA '//thmiis.za.tryhackme.com/admin$/' EZpass4ever
```

Connect anonymously to SMB share

```
$ smbclient //IPADDRESSS/SHARE -N (no password)
```

##### [enum4linux](https://github.com/CiscoCXSecurity/enum4linux)
Enumerate SMB using enum4linux

```
$ enum4linux [OPTIONS] IP_ADDRESS
```

##### [CrackMapExec](https://github.com/byt3bl33d3r/CrackMapExec)
List shares using crackmapexec

```
crackmapexec smb IP_ADDRESS -u guest -p "" --shares
```

Spider SMB Shares, using crackmapexec

```
crackmapexec smb IP_ADDRESS -u guest -p "" -M spider_plus
```

Check Credentials

```
crackmapexec smb IP_ADDRESS -u USERNAME -p 'PASSWORD'
```

Password Spray Users

```
crackmapexec smb 10.10.10.169 -u users -p 'PASSWORD' --continue-on-success
```

##### [mount](https://man7.org/linux/man-pages/man8/mount.8.html) / [umount](https://man7.org/linux/man-pages/man8/umount.8.html)
Mount an SMB share

```
mount //IP_ADDRESS/SHARE_NAME /LOCAL_DIR_USED_WHEN_MOUNTING
```

*Don't use /tmp when mounting a share, other local tools like CME use this directory and fail when it is mounted to an SMB share.* 


Unmount an SMB share

```
sudo umount /LOCAL_DIR_USED_WHEN_MOUNTING
```

##### [smbGet](https://www.samba.org/samba/docs/current/man-html/smbget.1.html)
Download the contents of an SMB share.

```
smbget -U USER_NAME smb://IP_ADDRESS/PATH_TO_FILE
smbget -R # recursive
```

##### [nulllinux](https://github.com/m8r0wn/nullinux)

```
nulllinux TARGET # -
```

##### Other/Utils
Check credentials using *psexec.py*

```
$ python psexec.py 'USER':'PASS'@IP_ADDRESS
```

Generate list of SMB Shares 

```
smbclient -N -L \\\\IP_ADDRESS | grep Disk | sed 's/^\s*\(.*\)\s*Disk.*/\1/'
```

Loop through list of shares and print contents.

```
smbclient -N -L \\\\IP_ADDRESS | grep Disk | sed 's/^\s*\(.*\)\s*Disk.*/\1/' | while read share; do echo "======${share}======"; smbclient -N "//IP_ADDRESS/${share}" -c dir; echo; done
```